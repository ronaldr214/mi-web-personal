// build-posts.js - Script para generar posts.json desde archivos markdown
const fs = require('fs');
const path = require('path');
const matter = require('gray-matter');

const postsDirectory = path.join(process.cwd(), '_posts');
const outputFile = path.join(process.cwd(), 'posts.json');

function getAllPosts() {
    const posts = [];
    
    try {
        // Verificar si la carpeta _posts existe
        if (!fs.existsSync(postsDirectory)) {
            console.log('Carpeta _posts no encontrada, creando posts.json vacío');
            fs.writeFileSync(outputFile, JSON.stringify([]));
            return;
        }
        
        const files = fs.readdirSync(postsDirectory);
        
        files.forEach(filename => {
            if (filename.endsWith('.md')) {
                const filePath = path.join(postsDirectory, filename);
                const fileContents = fs.readFileSync(filePath, 'utf8');
                const { data, content } = matter(fileContents);
                
                // Crear slug del nombre del archivo
                const slug = `/blog/${filename.replace('.md', '')}`;
                
                posts.push({
                    title: data.title || 'Sin título',
                    slug: slug,
                    date: data.date || new Date().toISOString(),
                    featured_image: data.featured_image || data.image || '',
                    excerpt: data.excerpt || data.description || '',
                    category: data.category || 'General',
                    author: data.author || 'Ronald Rangel',
                    body: content,
                    filename: filename
                });
            }
        });
        
        // Ordenar posts por fecha (más recientes primero)
        posts.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        // Escribir archivo JSON
        fs.writeFileSync(outputFile, JSON.stringify(posts, null, 2));
        console.log(`✅ Generados ${posts.length} posts en posts.json`);
        
    } catch (error) {
        console.error('Error al procesar posts:', error);
        // Crear archivo vacío en caso de error
        fs.writeFileSync(outputFile, JSON.stringify([]));
    }
}

// Ejecutar si se llama directamente
if (require.main === module) {
    getAllPosts();
}

module.exports = { getAllPosts };

// ==========================================
// admin/config.yml - Configuración de Netlify CMS
// ==========================================

/*
backend:
  name: git-gateway
  branch: main

media_folder: "assets"
public_folder: "/assets"

collections:
  - name: "posts"
    label: "Posts del Blog"
    folder: "_posts"
    create: true
    slug: "{{year}}-{{month}}-{{day}}-{{slug}}"
    fields:
      - { label: "Título", name: "title", widget: "string" }
      - { label: "Fecha", name: "date", widget: "datetime" }
      - { label: "Imagen Destacada", name: "featured_image", widget: "image" }
      - { label: "Categoría", name: "category", widget: "select", options: ["Marketing Digital", "Branding", "Desarrollo Web", "Inteligencia Artificial", "Estrategia", "General"] }
      - { label: "Extracto", name: "excerpt", widget: "text" }
      - { label: "Contenido", name: "body", widget: "markdown" }
      - { label: "Destacado", name: "featured", widget: "boolean", default: false }
*/

// ==========================================
// blog.html - Página principal del blog
// ==========================================

/*
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog - Ronald Rangel | Estratega Digital</title>
    <meta name="description" content="Artículos sobre marketing digital, branding, desarrollo web e inteligencia artificial para hacer crecer tu negocio.">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="container">
                <a href="/" class="logo">Ronald Rangel</a>
                <ul class="nav-menu">
                    <li><a href="/">Inicio</a></li>
                    <li><a href="/blog" class="active">Blog</a></li>
                    <li><a href="/#servicios">Servicios</a></li>
                    <li><a href="/#contacto">Contacto</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="blog-page">
        <section class="blog-hero">
            <div class="container">
                <h1>Blog de Estrategia Digital</h1>
                <p>Contenido estratégico para hacer crecer tu negocio en el mundo digital</p>
            </div>
        </section>

        <section class="blog-content">
            <div class="container">
                <div class="blog-grid" id="blogGrid">
                    <!-- Los posts se cargarán aquí -->
                </div>
                
                <div class="no-posts" id="noPosts" style="display: none;">
                    <h3>Próximamente</h3>
                    <p>Estoy preparando contenido increíble para ti. ¡Muy pronto tendrás acceso a artículos que te ayudarán a potenciar tu negocio!</p>
                </div>
            </div>
        </section>
    </main>

    <script src="blog.js"></script>
</body>
</html>
*/

// ==========================================
// blog.js - JavaScript para el blog
// ==========================================

// Función para cargar todos los posts
async function loadBlogPosts() {
    try {
        const response = await fetch('/posts.json');
        const posts = await response.json();
        
        if (!posts || posts.length === 0) {
            document.getElementById('noPosts').style.display = 'block';
            return;
        }
        
        const blogGrid = document.getElementById('blogGrid');
        
        blogGrid.innerHTML = posts.map(post => `
            <article class="blog-card">
                <div class="blog-image">
                    <img src="${post.featured_image || '/assets/default-blog-image.webp'}" 
                         alt="${post.title}"
                         onerror="this.src='/assets/default-blog-image.webp'">
                    ${post.category ? `<span class="blog-category">${post.category}</span>` : ''}
                </div>
                <div class="blog-content">
                    <div class="blog-meta">
                        <span class="blog-date">${new Date(post.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                        <span class="blog-author">Por ${post.author}</span>
                    </div>
                    <h2 class="blog-title">
                        <a href="${post.slug}">${post.title}</a>
                    </h2>
                    <p class="blog-excerpt">${post.excerpt || (post.body ? post.body.substring(0, 150) + '...' : '')}</p>
                    <a href="${post.slug}" class="read-more-btn">Leer artículo completo</a>
                </div>
            </article>
        `).join('');
        
    } catch (error) {
        console.error('Error loading blog posts:', error);
        document.getElementById('noPosts').style.display = 'block';
    }
}

// Función para cargar un post individual
async function loadSinglePost() {
    const path = window.location.pathname;
    const postId = path.split('/').pop();
    
    try {
        const response = await fetch('/posts.json');
        const posts = await response.json();
        
        const post = posts.find(p => p.slug === path || p.filename.replace('.md', '') === postId);
        
        if (!post) {
            document.body.innerHTML = '<h1>Artículo no encontrado</h1><p><a href="/blog">Volver al blog</a></p>';
            return;
        }
        
        // Renderizar el post completo
        document.title = `${post.title} - Ronald Rangel`;
        
        const postHtml = `
            <article class="single-post">
                <header class="post-header">
                    <div class="container">
                        <nav class="breadcrumb">
                            <a href="/">Inicio</a> > <a href="/blog">Blog</a> > ${post.title}
                        </nav>
                        ${post.category ? `<span class="post-category">${post.category}</span>` : ''}
                        <h1 class="post-title">${post.title}</h1>
                        <div class="post-meta">
                            <span>Por ${post.author}</span>
                            <span>${new Date(post.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                        </div>
                    </div>
                </header>
                
                ${post.featured_image ? `
                <div class="post-featured-image">
                    <img src="${post.featured_image}" alt="${post.title}">
                </div>
                ` : ''}
                
                <div class="post-content">
                    <div class="container">
                        <div class="post-body">
                            ${markdownToHtml(post.body)}
                        </div>
                        
                        <div class="post-footer">
                            <div class="post-share">
                                <h4>Comparte este artículo</h4>
                                <div class="share-buttons">
                                    <a href="https://wa.me/?text=${encodeURIComponent(post.title + ' - ' + window.location.href)}" class="share-btn whatsapp">WhatsApp</a>
                                    <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}" class="share-btn linkedin">LinkedIn</a>
                                    <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(window.location.href)}" class="share-btn twitter">Twitter</a>
                                </div>
                            </div>
                            
                            <div class="back-to-blog">
                                <a href="/blog" class="btn-secondary">← Volver al blog</a>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        `;
        
        document.body.innerHTML = postHtml;
        
    } catch (error) {
        console.error('Error loading post:', error);
        document.body.innerHTML = '<h1>Error cargando el artículo</h1><p><a href="/blog">Volver al blog</a></p>';
    }
}

// Función simple para convertir markdown a HTML (básica)
function markdownToHtml(markdown) {
    return markdown
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
        .replace(/\*(.*)\*/gim, '<em>$1</em>')
        .replace(/!\[([^\]]*)\]\(([^\)]*)\)/gim, '<img alt="$1" src="$2" />')
        .replace(/\[([^\]]*)\]\(([^\)]*)\)/gim, '<a href="$2">$1</a>')
        .replace(/\n\n/gim, '</p><p>')
        .replace(/^(.*)$/gim, '<p>$1</p>');
}

// Determinar qué cargar según la página
document.addEventListener('DOMContentLoaded', function() {
    const path = window.location.pathname;
    
    if (path === '/blog' || path === '/blog/') {
        loadBlogPosts();
    } else if (path.startsWith('/blog/')) {
        loadSinglePost();
    }
});

// ==========================================
// package.json - Scripts de construcción
// ==========================================

/*
{
  "name": "ronald-rangel-blog",
  "version": "1.0.0",
  "scripts": {
    "build": "node build-posts.js",
    "dev": "node build-posts.js && python -m http.server 8000",
    "prebuild": "node build-posts.js"
  },
  "dependencies": {
    "gray-matter": "^4.0.3"
  }
}
*/
